<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/chat.css">
    <script src="js/common.js"></script>
    <script src="js/bscroll.min.js"></script>
    <script src="js/jquery-1.11.2.min.js"></script>
    <title>智能回复</title>
</head>
<body>
    <div id="chat-box">
        <div class="chat-wrap">
            <div class="pull-down-wrap">下拉刷新</div>
        </div>
    </div>
    <div class="option integral-shadow">
        <input type="text" placeholder="有问题 找昌哥">
        <img src="imgs/send_no.png" alt="" class="send" data-img="imgs/send.png">
        <!-- <img src="imgs/send_no.png" alt=""> -->
    </div>
</body>
</html>
<script>
    $(function(){
        // 点击发送消息
        var scroll = null;
        setTimeout(function(){
            var scrollBox = document.getElementById('chat-box');
            scroll = new BScroll(scrollBox, {
                click:true,
                // bounce:false,
                probeType:0,
                pullDownRefresh: {
                    threshold: 50,
                    stop: 50
                }
            });
            //下拉加载
            scroll.on('pullingDown',function(){
                // alert(111)
                // scroll.finishPullDown();
                $('.pull-down-wrap').text('加载中 · · ·');
                setTimeout(function(){
                    $('.pull-down-wrap').text('加载成功');
                    setTimeout(function(){
                        $('.pull-down-wrap').text('下拉刷新');
                        scroll.finishPullDown();
                    },1000);   
                },2000);
            })
        },200)
         


        // 输入框输入内容
		var inputText = '';
		$('.option input').bind('input propertychange', function(){
			if ($(this).val().trim()) {
				$('.option .send').attr('src','imgs/send.png')
			} else {
				$('.option .send').attr('src','imgs/send_no.png')
			}
			inputText = $(this).val();
		});


		

        //键盘弹出
        var winHeight = $(window).height();   
        $(window).resize(function(){
            var thisHeight=$(this).height();
            if(winHeight - thisHeight >50){
                scrollToBottom();
            }
        });

        function scrollToBottom() {
            var scrolly = $('.chat-wrap').height()-$(window).height()+$('.option').height();
            scroll.scrollTo(0,-scrolly,100,'linear');
        }


        // 双向通信
        var ws = new WebSocket('ws://echo.websocket.org');  
  
        ws.onopen = function(){
            wx.showToast({
				title:'通信已连接',
				duration:1000
			})
        };  
        
        ws.onmessage = function(evt){console.log(evt.data)};  
        
        ws.onclose = function(evt){
            wx.showToast({
				title:'连接已断开',
				duration:1000
			})
        };  
        
        ws.onerror = function(evt){
            wx.showToast({
				title:'出错了',
				duration:1000
			})
        }; 
        // 点击提交按钮
		$('.send ').click(function(e){
			if (!inputText.trim()){
				return;
			}
            $('.chat-wrap').append('<div>'+inputText+'</div>');
            ws.send(inputText);
            $('.option input').val('');
            $('.option .send').attr('src','imgs/send_no.png');
            scroll.refresh();
            inputText = '';
            scrollToBottom();
			// alert(333)
        })
        $('.option').click(function(){
            $('.option input').focus();
        })
    })
    
</script>